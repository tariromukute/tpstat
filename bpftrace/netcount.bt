#!/usr/local/bin/bpftrace

/**
 * shows the number of received and sent packets from the net device layer.
 */
BEGIN
{
        printf("Tracing net device send/receive. Hit Ctrl-C to end.\n");
        @begin = nsecs;
}

tracepoint:net:napi_gro_receive_entry
{
        @nic_send_count[str(args->name)] = count();
}

tracepoint:net:net_dev_xmit
{
        @nic_send_count[str(args->name)] = count();
}

interval:s:10
{
       print(@nic_send_bytes);
       clear(@nic_send_bytes);

       print(@nic_recv_bytes);
       clear(@nic_recv_bytes);

       print(@send_bytes);
       clear(@send_bytes);

       print(@recv_bytes);
       clear(@recv_bytes);
}

END
{
    printf("Duration %d ms \n", (nsecs - @begin)/1000000);
}